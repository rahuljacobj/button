<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Persistent Click Counter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom animation for the button press */
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        .click-anim {
            animation: press 0.1s ease-in-out;
        }

        @keyframes press {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        /* Prevent text selection on rapid clicking */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center justify-center font-sans overflow-hidden relative">

    <!-- Background decorative elements -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 opacity-20">
        <div class="absolute top-10 left-10 w-64 h-64 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl animate-blob"></div>
        <div class="absolute top-10 right-10 w-64 h-64 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-20 w-64 h-64 bg-pink-600 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-4000"></div>
    </div>

    <div class="z-10 text-center px-4">
        <!-- The Main Button Container -->
        <div class="relative group">
            <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
            
            <button 
                id="clickBtn" 
                class="relative w-64 h-64 md:w-80 md:h-80 rounded-full bg-slate-800 border-4 border-slate-700 hover:border-blue-500 transition-all duration-300 flex flex-col items-center justify-center shadow-2xl no-select active:scale-95 focus:outline-none focus:ring-4 focus:ring-blue-500/30"
                aria-label="Increment Counter"
            >
                <div class="text-slate-500 text-sm uppercase tracking-widest mb-2 font-semibold">Total Clicks</div>
                <div id="countDisplay" class="text-6xl md:text-8xl font-black text-white tracking-tighter tabular-nums transition-colors duration-200">
                    <i class="fas fa-circle-notch fa-spin text-4xl text-slate-600"></i>
                </div>
            </button>
        </div>
        
        <p class="mt-8 text-slate-500 text-xs">
            <i class="fas fa-globe-americas mr-1"></i> Global Live Counter
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // CONFIGURATION SECTION
        // =================================================================================
        
        const manualConfig = {
          apiKey: "AIzaSyBSRzlMHMWV3STyek6_43bJY-FK91RzP1k",
          authDomain: "button-a4eee.firebaseapp.com",
          databaseURL: "https://button-a4eee-default-rtdb.firebaseio.com",
          projectId: "button-a4eee",
          storageBucket: "button-a4eee.firebasestorage.app",
          messagingSenderId: "382328799126",
          appId: "1:382328799126:web:f166354bfd998a41b9a7b7",
          measurementId: "G-WML1QBVT09"
        }; 

        // =================================================================================

        // Determine which config to use
        let firebaseConfig;
        let appId;
        
        try {
            // PRIORITY 1: Check if running in the Canvas Preview Environment
            // We must use the internal config/token here to avoid auth errors.
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
                
            // PRIORITY 2: Fallback to Manual Config (e.g. GitHub Pages)
            // This runs when the file is hosted externally where __firebase_config is missing.
            } else if (manualConfig) {
                firebaseConfig = manualConfig;
                appId = 'github-hosted-app';
            } else {
                console.error("No Firebase configuration found.");
            }
        } catch (e) {
            console.error("Error parsing config", e);
        }

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            const clickBtn = document.getElementById('clickBtn');
            const countDisplay = document.getElementById('countDisplay');
            let currentUser = null;

            // Initialize Auth and Listeners
            const init = async () => {
                try {
                    // Authenticate
                    // If in Canvas, use the injected custom token.
                    // If on GitHub, use Anonymous auth (Ensure "Anonymous" is enabled in your Firebase Console!)
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    currentUser = auth.currentUser;
                    
                    if (!currentUser) return;

                    // Reference to the global counter document
                    // We use a specific path to ensure data persists correctly
                    const counterRef = doc(db, 'artifacts', appId, 'public', 'data', 'counters', 'global');

                    // Real-time listener: This updates the screen whenever ANYONE clicks
                    onSnapshot(counterRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            updateDisplay(data.count || 0);
                        } else {
                            // If it's the very first time, create the document
                            setDoc(counterRef, { count: 0 });
                            updateDisplay(0);
                        }
                    }, (error) => {
                        console.error("Error getting document:", error);
                        countDisplay.innerHTML = '<span class="text-sm text-red-400">Error</span>';
                    });

                    // Click Handler
                    clickBtn.addEventListener('click', async (e) => {
                        if (!currentUser) return;

                        // Visuals
                        clickBtn.classList.add('click-anim');
                        setTimeout(() => clickBtn.classList.remove('click-anim'), 100);
                        createParticle(e.clientX, e.clientY);

                        // Database Update: Atomic increment ensures accuracy with multiple users
                        try {
                            await updateDoc(counterRef, {
                                count: increment(1)
                            });
                        } catch (err) {
                            // If doc missing, create it
                            if (err.code === 'not-found') {
                                await setDoc(counterRef, { count: 1 });
                            }
                        }
                    });

                } catch (error) {
                    console.error("Initialization error:", error);
                }
            };

            init();

            // UI Helper Functions
            function updateDisplay(val) {
                countDisplay.textContent = val.toLocaleString();
                if(val > 0 && val % 100 === 0) {
                    countDisplay.classList.add('text-yellow-400');
                    setTimeout(() => countDisplay.classList.remove('text-yellow-400'), 500);
                }
            }

            function createParticle(x, y) {
                if(x === 0 && y === 0) {
                    const rect = clickBtn.getBoundingClientRect();
                    x = rect.left + rect.width / 2;
                    y = rect.top + rect.height / 2;
                }

                const particle = document.createElement('div');
                particle.className = 'fixed pointer-events-none text-blue-500 font-bold text-xl select-none z-50';
                particle.textContent = '+1';
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.transition = 'all 0.8s ease-out';
                particle.style.opacity = '1';
                
                document.body.appendChild(particle);

                requestAnimationFrame(() => {
                    particle.style.transform = `translate(-50%, -100px)`;
                    particle.style.opacity = '0';
                });

                setTimeout(() => {
                    particle.remove();
                }, 800);
            }
        }
    </script>
</body>
</html>
